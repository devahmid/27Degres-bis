<div class="max-w-7xl mx-auto px-4">
  <div class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between">
    <div>
      <h1 class="text-4xl font-bold mb-2 text-dark">Gestion des Membres</h1>
      <p class="text-gray-600">Gérez tous les membres de l'association</p>
    </div>
    <button mat-raised-button color="primary" (click)="openAddDialog()" class="mt-4 md:mt-0">
      <mat-icon class="mr-2">person_add</mat-icon>
      Ajouter un membre
    </button>
  </div>

  <!-- Filters -->
  <mat-card class="mb-6">
    <mat-card-content>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label class="block text-dark font-medium mb-2">Rechercher</label>
          <div class="relative">
            <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
            <input 
              type="text" 
              [(ngModel)]="searchTerm" 
              (ngModelChange)="onSearchChange()" 
              placeholder="Nom, prénom, email..."
              class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
          </div>
        </div>
        <div>
          <label class="block text-dark font-medium mb-2">Rôle</label>
          <select 
            [(ngModel)]="filterRole" 
            (ngModelChange)="onSearchChange()"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all bg-white">
            <option value="">Tous</option>
            <option value="admin">Admin</option>
            <option value="bureau">Bureau</option>
            <option value="membre">Membre</option>
            <option value="visiteur">Visiteur</option>
          </select>
        </div>
        <div>
          <label class="block text-dark font-medium mb-2">Statut</label>
          <select 
            [(ngModel)]="filterStatus" 
            (ngModelChange)="onSearchChange()"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all bg-white">
            <option value="">Tous</option>
            <option value="active">Actifs</option>
            <option value="inactive">Inactifs</option>
          </select>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Members Table -->
  <mat-card>
    <mat-card-content>
      <table mat-table [dataSource]="filteredMembers$" class="w-full">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Nom</th>
          <td mat-cell *matCellDef="let member">
            <div class="flex items-center">
              <mat-icon class="mr-2 text-gray-400">person</mat-icon>
              <span>{{ member.firstName }} {{ member.lastName }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef>Email</th>
          <td mat-cell *matCellDef="let member">{{ member.email }}</td>
        </ng-container>

        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef>Rôle</th>
          <td mat-cell *matCellDef="let member">
            <span [ngClass]="{
              'bg-red-100 text-red-800': member.role === 'admin',
              'bg-blue-100 text-blue-800': member.role === 'bureau',
              'bg-green-100 text-green-800': member.role === 'membre',
              'bg-gray-100 text-gray-800': member.role === 'visiteur'
            }" class="px-2 py-1 rounded-full text-xs font-medium capitalize">
              {{ member.role }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Statut</th>
          <td mat-cell *matCellDef="let member">
            <span [ngClass]="{
              'bg-green-100 text-green-800': member.isActive,
              'bg-gray-100 text-gray-800': !member.isActive
            }" class="px-2 py-1 rounded-full text-xs font-medium">
              {{ member.isActive ? 'Actif' : 'Inactif' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="joinDate">
          <th mat-header-cell *matHeaderCellDef>Date d'adhésion</th>
          <td mat-cell *matCellDef="let member">{{ member.joinDate | dateFormat }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let member; let i = index" class="relative" style="position: relative;">
            <button 
              mat-icon-button 
              type="button"
              [attr.data-member-id]="member.id"
              (click)="toggleMenu(member.id, $event)"
              class="relative z-10">
              <mat-icon>more_vert</mat-icon>
            </button>
            
            <!-- Menu dropdown simple -->
            <div 
              *ngIf="openMenuId === member.id" 
              class="menu-dropdown"
              [attr.data-member-id]="member.id"
              (click)="$event.stopPropagation()">
              <button 
                class="menu-item w-full px-4 py-2 text-left hover:bg-gray-100 flex items-center gap-2 text-gray-700"
                (click)="editMember(member); closeMenus()">
                <mat-icon class="text-gray-500">edit</mat-icon>
                <span>Modifier</span>
              </button>
              <button 
                class="menu-item w-full px-4 py-2 text-left hover:bg-gray-100 flex items-center gap-2 text-gray-700"
                (click)="sendMessage(member); closeMenus()">
                <mat-icon class="text-gray-500">email</mat-icon>
                <span>Envoyer un message</span>
              </button>
              <hr class="my-1">
              <div class="relative">
                <button 
                  class="menu-item w-full px-4 py-2 text-left hover:bg-gray-100 flex items-center justify-between text-gray-700"
                  (click)="toggleRoleMenu(member.id, $event)">
                  <div class="flex items-center gap-2">
                    <mat-icon class="text-gray-500">admin_panel_settings</mat-icon>
                    <span>Changer le rôle</span>
                  </div>
                  <mat-icon class="text-gray-400">arrow_right</mat-icon>
                </button>
                
                <!-- Sous-menu des rôles -->
                <div 
                  *ngIf="openRoleMenuId === member.id"
                  class="absolute left-full top-0 ml-1 bg-white rounded-lg shadow-lg border border-gray-200 py-2 min-w-[150px] z-50">
                  <button 
                    class="w-full px-4 py-2 text-left hover:bg-gray-100 flex items-center gap-2 text-gray-700"
                    (click)="changeRole(member, 'admin'); closeMenus()">
                    <mat-icon class="text-gray-500">admin_panel_settings</mat-icon>
                    <span>Admin</span>
                  </button>
                  <button 
                    class="w-full px-4 py-2 text-left hover:bg-gray-100 flex items-center gap-2 text-gray-700"
                    (click)="changeRole(member, 'bureau'); closeMenus()">
                    <mat-icon class="text-gray-500">group</mat-icon>
                    <span>Bureau</span>
                  </button>
                  <button 
                    class="w-full px-4 py-2 text-left hover:bg-gray-100 flex items-center gap-2 text-gray-700"
                    (click)="changeRole(member, 'membre'); closeMenus()">
                    <mat-icon class="text-gray-500">person</mat-icon>
                    <span>Membre</span>
                  </button>
                  <button 
                    class="w-full px-4 py-2 text-left hover:bg-gray-100 flex items-center gap-2 text-gray-700"
                    (click)="changeRole(member, 'visiteur'); closeMenus()">
                    <mat-icon class="text-gray-500">visibility</mat-icon>
                    <span>Visiteur</span>
                  </button>
                </div>
              </div>
              <button 
                class="menu-item w-full px-4 py-2 text-left hover:bg-gray-100 flex items-center gap-2 text-gray-700"
                (click)="toggleMemberStatus(member); closeMenus()">
                <mat-icon class="text-gray-500">{{ member.isActive ? 'block' : 'check_circle' }}</mat-icon>
                <span>{{ member.isActive ? 'Bloquer' : 'Débloquer' }}</span>
              </button>
              <hr class="my-1">
              <button 
                class="menu-item w-full px-4 py-2 text-left hover:bg-gray-100 flex items-center gap-2 text-gray-700"
                (click)="viewMemberCotisations(member); closeMenus()">
                <mat-icon class="text-gray-500">credit_card</mat-icon>
                <span>Voir cotisations</span>
              </button>
              <button 
                class="menu-item w-full px-4 py-2 text-left hover:bg-red-50 flex items-center gap-2 text-red-600"
                (click)="deleteMember(member); closeMenus()">
                <mat-icon class="text-red-500">delete</mat-icon>
                <span>Supprimer</span>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
      
      <div *ngIf="(filteredMembers$ | async)?.length === 0" class="text-center py-8 text-gray-500">
        Aucun membre trouvé
      </div>
    </mat-card-content>
  </mat-card>

</div>
