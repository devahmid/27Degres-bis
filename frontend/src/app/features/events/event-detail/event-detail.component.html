<div class="container mx-auto px-4 py-8" *ngIf="event$ | async as event">
  <mat-card>
    <img *ngIf="event.featuredImage" mat-card-image [src]="event.featuredImage" [alt]="event.title" class="max-h-96 object-cover">
    <mat-card-header>
      <mat-card-title class="text-3xl">{{ event.title }}</mat-card-title>
      <mat-card-subtitle>
        {{ event.startDate | dateFormat:'dd MMMM yyyy' }}
        <span *ngIf="event.endDate"> - {{ event.endDate | dateFormat:'dd MMMM yyyy' }}</span>
        <span *ngIf="event.location"> - {{ event.location }}</span>
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div [innerHTML]="event.description | formatContent" class="prose max-w-none article-content"></div>
    </mat-card-content>
    <mat-card-actions>
      <div *ngIf="authService.isLoggedIn(); else loginPrompt" class="w-full">
        <div *ngIf="checkingRegistration" class="text-center py-4">
          <mat-icon class="animate-spin">refresh</mat-icon>
          <span class="ml-2">Vérification de votre inscription...</span>
        </div>
        <div *ngIf="!checkingRegistration">
          <button 
            *ngIf="!isRegistered"
            mat-raised-button 
            color="primary" 
            (click)="registerForEvent(event)"
            class="w-full">
            <mat-icon>event_available</mat-icon>
            <span class="ml-2">S'inscrire à cet événement</span>
          </button>
          <div *ngIf="isRegistered" class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex items-center gap-3 mb-3">
              <mat-icon class="text-green-600">check_circle</mat-icon>
              <div class="flex-grow">
                <p class="font-semibold text-green-800">Vous êtes inscrit à cet événement</p>
                <p class="text-sm text-green-600">Vous recevrez une confirmation par email</p>
              </div>
            </div>
            <button 
              mat-stroked-button 
              color="warn" 
              (click)="unregisterFromEvent(event.id)"
              class="w-full">
              <mat-icon>cancel</mat-icon>
              <span class="ml-2">Se désinscrire</span>
            </button>
          </div>
        </div>
      </div>
      <ng-template #loginPrompt>
        <div class="w-full bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
          <mat-icon class="text-blue-600 mb-2">info</mat-icon>
          <p class="text-blue-800 mb-3">Vous devez être connecté pour vous inscrire</p>
          <a mat-raised-button color="primary" routerLink="/auth/login" class="w-full">
            <mat-icon>login</mat-icon>
            <span class="ml-2">Se connecter</span>
          </a>
        </div>
      </ng-template>
    </mat-card-actions>
  </mat-card>

  <!-- Liste des inscrits (uniquement pour les utilisateurs connectés) -->
  <mat-card *ngIf="authService.isLoggedIn()" class="mt-6">
    <mat-card-header>
      <mat-card-title class="text-2xl flex items-center gap-2">
        <mat-icon>people</mat-icon>
        Participants inscrits
        <span class="text-lg font-normal text-gray-600 ml-2">
          ({{ registrations.length }})
        </span>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="loadingRegistrations" class="text-center py-12">
        <mat-icon class="text-4xl text-gray-400 animate-spin">refresh</mat-icon>
        <p class="mt-4 text-gray-600">Chargement des inscriptions...</p>
      </div>

      <div *ngIf="!loadingRegistrations && registrations.length === 0" class="text-center py-12">
        <mat-icon class="text-4xl text-gray-400">people_outline</mat-icon>
        <p class="mt-4 text-gray-600">Aucune inscription pour le moment</p>
        <p class="text-sm text-gray-500 mt-2">Soyez le premier à vous inscrire !</p>
      </div>

      <div *ngIf="!loadingRegistrations && registrations.length > 0" class="space-y-3">
        <div 
          *ngFor="let reg of registrations" 
          class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow">
          <div 
            class="bg-gray-50 p-4 cursor-pointer hover:bg-gray-100 transition-colors"
            (click)="toggleRegistrationDetails(reg.id)">
            <div class="flex items-center gap-4 flex-wrap">
              <div class="flex-1 min-w-[200px]">
                <p class="font-semibold text-dark text-lg">
                  {{ reg.user.firstName }} {{ reg.user.lastName }}
                </p>
                <p class="text-sm text-gray-500 mt-1">
                  Inscrit le {{ reg.registeredAt | dateFormat }}
                </p>
              </div>
              
              <div class="flex items-center gap-2 flex-wrap">
                <span 
                  class="px-3 py-1 rounded-full text-xs font-medium"
                  [ngClass]="reg.availabilityType === 'full' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'">
                  <mat-icon class="text-sm align-middle">schedule</mat-icon>
                  {{ getAvailabilityLabel(reg) }}
                </span>
                
                <span 
                  *ngIf="reg.isVolunteer"
                  class="px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-medium flex items-center gap-1">
                  <mat-icon class="text-sm">volunteer_activism</mat-icon>
                  Volontaire
                </span>
              </div>
              
              <mat-icon 
                [class.rotate-180]="expandedRegistrationId === reg.id" 
                class="transition-transform text-gray-400">
                expand_more
              </mat-icon>
            </div>
          </div>
          
          <!-- Détails expandables -->
          <div 
            *ngIf="expandedRegistrationId === reg.id" 
            class="p-4 bg-white border-t border-gray-200 animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div *ngIf="reg.availabilityType === 'partial' && reg.availabilityDetails" class="md:col-span-2">
                <h4 class="font-semibold text-dark mb-2 flex items-center gap-2">
                  <mat-icon class="text-lg text-yellow-600">schedule</mat-icon>
                  Disponibilités
                </h4>
                <p class="text-gray-700 whitespace-pre-wrap bg-yellow-50 p-3 rounded">{{ reg.availabilityDetails }}</p>
              </div>
              
              <div *ngIf="reg.isVolunteer && reg.volunteerActivities && reg.volunteerActivities.length > 0" class="md:col-span-2">
                <h4 class="font-semibold text-dark mb-2 flex items-center gap-2">
                  <mat-icon class="text-lg text-blue-600">volunteer_activism</mat-icon>
                  Activités de volontariat
                </h4>
                <p class="text-gray-700">{{ getVolunteerActivitiesLabel(reg.volunteerActivities) }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>









